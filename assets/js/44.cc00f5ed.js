(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{523:function(t,s,a){"use strict";a.r(s);var e=a(4),r=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"如何清理-git-仓库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何清理-git-仓库"}},[t._v("#")]),t._v(" 如何清理 Git 仓库")]),t._v(" "),a("h2",{attrs:{id:"仓库原来越大的原因"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#仓库原来越大的原因"}},[t._v("#")]),t._v(" 仓库原来越大的原因")]),t._v(" "),a("p",[a("code",[t._v("git")]),t._v(" 会把文件的每一个差异化版本都记录在案。即使你只改动了某个文件的一行内容，"),a("code",[t._v("git")]),t._v(" 也会生成一个全新的 "),a("code",[t._v("blob")]),t._v(" 对象来存储新的文件内容。"),a("code",[t._v("git gc")]),t._v(" 打包或者每次 "),a("code",[t._v("git push")]),t._v(" 的时候 "),a("code",[t._v("git")]),t._v(" 都会自动执行一次打包过程，将 "),a("code",[t._v("blob")]),t._v(" 对象合并成一个包文件，同时会生成一个索引文件，索引文件中包含了每个 "),a("code",[t._v("blob")]),t._v(" 对象在包文件中的偏移信息，在打包的过程中使用了增量编码方案，只保存 "),a("code",[t._v("blob")]),t._v(" 对象的不同版本之间的差异，这会减缓仓库变大的速度。但是整体还是一个上涨的过程。")]),t._v(" "),a("h2",{attrs:{id:"处理方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#处理方法"}},[t._v("#")]),t._v(" 处理方法")]),t._v(" "),a("h3",{attrs:{id:"方法一"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#方法一"}},[t._v("#")]),t._v(" 方法一")]),t._v(" "),a("p",[t._v("方法一的核心是清理大文件或者不再需要的文件(后文统称为冗余文件)，以及他们所产生的提交记录。"),a("strong",[t._v("下面的操作一定要三思而行，真的会把文件删除的哟！")])]),t._v(" "),a("ol",[a("li",[a("p",[t._v("找到所有冗余文件的git记录")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" rev-list --objects --all "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" verify-pack -v .git/objects/pack/*.idx "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sort")]),t._v(" -k "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" -n "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("tail")]),t._v(" -5 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("awk")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{print "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$1")]),t._v("}'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v('"')]),t._v("\n")])])]),a("p",[t._v("解释一下上面的代码：")]),t._v(" "),a("ol",[a("li",[t._v("倒序列出的提交引用的任何对象的对象id")]),t._v(" "),a("li",[t._v("读取 git 归档后的idx文件，列出所有的对象列表，然后根据列表中的第三项(size)进行升序排序，然后取最后 5 项，截取第一列（SHA-1）")]),t._v(" "),a("li",[t._v("取操作一和操作二的交集，便是当前仓库中占用空间最大的5个文件或提交记录")])])]),t._v(" "),a("li",[a("p",[t._v("删除冗余文件以及相关提交记录")]),t._v(" "),a("p",[t._v("删除时，一定要核对好，因为上面一步输出的既包含了提交记录中的大文件，也包含当前仓库中的大文件。")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("删除文件")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" filter-branch --force --index-filter "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'git rm --cached --ignore-unmatch 文件名'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--prune-empty -- --all\n")])])])]),t._v(" "),a("li",[a("p",[t._v("删除文件夹")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" filter-branch --force --index-filter "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'git rm -r --cached --ignore-unmatch 文件夹名'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--prune-empty -- --all\n")])])])])])]),t._v(" "),a("li",[a("p",[t._v("删除缓存对象")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" for-each-ref --format"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'delete %(refname)'")]),t._v(" refs/original "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" update-ref --stdin\n "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" reflog expire --expire"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("now --all\n "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" gc --prune"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("now\n")])])])]),t._v(" "),a("li",[a("p",[t._v("推送至远程仓库")]),t._v(" "),a("p",[t._v("当你确认你的操作都没有问题后，就可以强制推送到远程了。")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" push --force\n")])])])])]),t._v(" "),a("h3",{attrs:{id:"方法二"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#方法二"}},[t._v("#")]),t._v(" 方法二")]),t._v(" "),a("p",[t._v("方法二比较暴力，直接"),a("strong",[t._v("将整个仓库的历史全部删掉")]),t._v("，以达到对git仓库瘦身的目的。")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("删除所有的远程分支")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" branch -r "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" origin "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" -v "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'>'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" -v master "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("xargs")]),t._v(" -L1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("awk")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{sub(/origin\\//,\"\");print}'")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("xargs")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" push origin --delete\n")])])])]),t._v(" "),a("li",[a("p",[t._v("删除本地的.git文件夹")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -rf .git\n")])])])]),t._v(" "),a("li",[a("p",[t._v("初始化本地的git仓库")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" init\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" commit -m "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"init"')]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("将本地的git仓库与已有的远程仓库进行关联")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" remote "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" origin 远程仓库地址"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("https://xxx.git 或 git@xxx.git 均可"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("强制推送到远程仓库")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" push -f origin master\n")])])])])]),t._v(" "),a("h2",{attrs:{id:"参考文献"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考文献"}},[t._v("#")]),t._v(" 参考文献")]),t._v(" "),a("ol",[a("li",[a("a",{attrs:{href:"https://git-scm.com/docs/git-rev-list",target:"_blank",rel:"noopener noreferrer"}},[t._v("git-rev-list"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://git-scm.com/docs/git-verify-pack",target:"_blank",rel:"noopener noreferrer"}},[t._v("git-verify-pack"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://git-scm.com/docs/git-filter-branch",target:"_blank",rel:"noopener noreferrer"}},[t._v("git-filter-branch"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.jianshu.com/p/7231b509c279",target:"_blank",rel:"noopener noreferrer"}},[t._v("为什么你的 Git 仓库变得如此臃肿"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.jianshu.com/p/4f2ccb48da77",target:"_blank",rel:"noopener noreferrer"}},[t._v("为什么.git/objects/pack文件夹变得非常大，处理git仓库臃肿"),a("OutboundLink")],1)])]),t._v(" "),a("hr"),t._v(" "),a("blockquote",[a("p",[t._v("Title: 如何清理 git 仓库")]),t._v(" "),a("p",[t._v("Date: 2020.07.28")]),t._v(" "),a("p",[t._v("Author: zhangpeng")]),t._v(" "),a("p",[t._v("Github: "),a("a",{attrs:{href:"https://github.com/fullstack-zhangpeng",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/fullstack-zhangpeng"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=r.exports}}]);